---
title: 'Are elevated lactate levels associated with ICU mortality?'
author: "..."
date: "January, 2025"
output:
  pdf_document: 
    toc: true
    toc_depth: 4
    number_sections: true
    fig_width: 7
    fig_height: 5
    fig_caption: true
    keep_tex: false
    latex_engine: xelatex
    highlight: tango
    citation_package: natbib
header-includes:
- \usepackage{xcolor}
- \usepackage{framed}
- \usepackage{listings}
- \usepackage{fancyhdr}
- \usepackage{geometry}
- \usepackage{caption}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{graphicx}
- \geometry{top=2.5cm, bottom=2.5cm, left=2.5cm, right=2.5cm}
- \pagestyle{fancy}
- \fancyfoot[C]{\thepage}
- \renewcommand{\headrulewidth}{0.4pt}
- \renewcommand{\footrulewidth}{0.4pt}
editor_options: 
  markdown: 
    wrap: 72
---

\newpage

Authors' information

\begin{center}
\begin{tabular}{|l|l|}
\hline
\textbf{Nombre} & Marco Russo \\
\hline
\textbf{Email} & mrussorb@uoc.edu \\
\hline
\textbf{GitHub} & https://github.com/marcusRB/ \\
\hline
\textbf{LinkedIn} & https://www.linkedin.com/in/marcusrb/ \\
\hline
\textbf{Fecha} & \today \\
\hline
\end{tabular}
\end{center}
\begin{center}
\begin{tabular}{|l|l|}
\hline
\textbf{Nombre} & ... \\
\hline
\textbf{Email} & ...@...
 \\
\hline
\textbf{GitHub} & https://github.com/ \\
\hline
\textbf{LinkedIn} & https://www.linkedin.com/in/ \\
\hline
\textbf{Fecha} & \today \\
\hline
\end{tabular}
\end{center}
\begin{center}
\begin{tabular}{|l|l|}
\hline
\textbf{Nombre} & ... \\
\hline
\textbf{Email} & ...@...
 \\
\hline
\textbf{GitHub} & https://github.com/ \\
\hline
\textbf{LinkedIn} & https://www.linkedin.com/in/ \\
\hline
\textbf{Fecha} & \today \\
\hline
\end{tabular}
\end{center}
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.width = 10, fig.height = 6)
```

# Project overview

**Research Question**: Are elevated lactate levels associated with ICU
mortality? Study Design: Retrospective cohort study using MIMIC-III
database Primary Analysis: Association between first lactate measurement
post-ICU admission and in-hospital mortality

## Data Description

MIMIC-III is a relational database consisting of 26 tables. Tables are
linked by identifiers which usually have the suffix ‘ID’. For example,
SUBJECT_ID refers to a unique patient, HADM_ID refers to a unique
admission to the hospital, and ICUSTAY_ID refers to a unique admission
to an intensive care unit.

Charted events such as notes, laboratory tests, and fluid balance are
stored in a series of ‘events’ tables. For example the OUTPUTEVENTS
table contains all measurements related to output for a given patient,
while the LABEVENTS table contains laboratory test results for a
patient.

Tables prefixed with ‘D\_’ are dictionary tables and provide definitions
for identifiers. For example, every row of CHARTEVENTS is associated
with a single ITEMID which represents the concept measured, but it does
not contain the actual name of the measurement. By joining CHARTEVENTS
and D_ITEMS on ITEMID, it is possible to identify the concept
represented by a given ITEMID.

Developing the MIMIC data model involved balancing simplicity of
interpretation against closeness to ground truth. As such, the model is
a reflection of underlying data sources, modified over iterations of the
MIMIC database in response to user feedback. Care has been taken to
avoid making assumptions about the underlying data when carrying out
transformations, so MIMIC-III closely represents the raw hospital data.

Broadly speaking, five tables are used to define and track patient
stays: ADMISSIONS; PATIENTS; ICUSTAYS; SERVICES; and TRANSFERS. Another
five tables are dictionaries for cross-referencing codes against their
respective definitions: D_CPT; D_ICD_DIAGNOSES; D_ICD_PROCEDURES;
D_ITEMS; and D_LABITEMS. The remaining tables contain data associated
with patient care, such as physiological measurements, caregiver
observations, and billing information.

In some cases it would be possible to merge tables—for example, the
D_ICD_PROCEDURES and CPTEVENTS tables both contain detail relating to
procedures and could be combined—but our approach is to keep the tables
independent for clarity, since the data sources are significantly
different. Rather than combining the tables within MIMIC data model, we
suggest researchers develop database views and transforms as
appropriate.

## MIMIC-III v1.4

The current version of the database is v1.4. When referencing this
version, we recommend using the full title: MIMIC-III v1.4[^1].

[^1]: Johnson, A., Pollard, T., & Mark, R. (2016). MIMIC-III Clinical
    Database (version 1.4). PhysioNet. RRID:SCR_007345.
    <https://doi.org/10.13026/C2XW26>

MIMIC-III v1.4 was released on 2 September 2016. It was a major release
enhancing data quality and providing a large amount of additional data
for Metavision patients.

------------------------------------------------------------------------

# Data Extraction & Preparation

## Database setup, cohort extraction

```{r database setup}
library(dplyr)
library(tidyr)
library(tibble)
library(lubridate)
library(readr)
library(stringr)
library(ggplot2)
library(data.table)
library(odbc)
library(RMariaDB)
```

```{r}
# Get the credentials file
# It looks like:
################
#username=your.user.name
#password=your.password.assigned
################
creds_file = "creds.txt"
```

```{r}
# Set the username and password
creds <- readLines(creds_file)
cred_list <- setNames(
  sub(".*=", "", creds),
  sub("=.*", "", creds)
)
```

```{r}
con <- dbConnect(
  drv = RMariaDB::MariaDB(),
  username = cred_list[["username"]],
  password = cred_list[["password"]],
  host = "ehr3.deim.urv.cat",
  dbname = "mimiciiiv14",
  port = 3306
)
```

```{r, results='hide'}
#| echo: false
dbListTables(con)
```

We constructed a cohort at the level of individual lactate measurements
obtained during ICU stays. Each row in the dataset corresponds to a
single lactate measurement, and all lactate values recorded during any
ICU stay were included.

Lactate measurements were assigned to ICU stays based on their
timestamp: a measurement was linked to an ICU stay only if it occurred
between the ICU admission (intime) and discharge (outtime) times.

ICU mortality was derived from hospital admission outcomes. For patients
with multiple ICU stays within the same hospital admission, ICU
mortality was assigned exclusively to the final ICU stay if the patient
died during that admission; all preceding ICU stays were labeled as
non-fatal. This approach allows ICU-level mortality attribution in the
absence of a direct ICU death indicator. The final cohort comprised
129,966 lactate measurements, representing multiple ICU stays and
hospital admissions across patients.

```{r}
cohort_query <- "
      WITH icu_ordered AS (
          SELECT
              i.subject_id,
              i.hadm_id,
              i.icustay_id,
              i.intime,
              i.outtime,
              a.hospital_expire_flag AS hospital_dead,
              ROW_NUMBER() OVER (
                  PARTITION BY i.subject_id, i.hadm_id
                  ORDER BY i.outtime DESC
              ) AS rn_icu
          FROM ICUSTAYS i
          JOIN ADMISSIONS a
              ON i.hadm_id = a.hadm_id
      )
      SELECT 
      	ROW_NUMBER() OVER (ORDER BY subject_id, hadm_id, icustay_id, charttime) AS row_id,
          subject_id,
          hadm_id,
          icustay_id,
          intime,
          outtime,
          hospital_dead,
          CASE 
              WHEN hospital_dead = 1 AND rn_icu = 1 THEN 1
              ELSE 0
          END AS icu_dead,
          l.CHARTTIME as lactate_time,
          l.VALUE as lactate_value,
          l.FLAG as lactate_flag
      FROM icu_ordered
      INNER JOIN LABEVENTS l USING(subject_id, hadm_id)
      WHERE l.ITEMID = 50813
      AND l.charttime BETWEEN intime AND outtime
      AND l.value is not null
      ORDER BY subject_id, hadm_id, icustay_id, outtime;
"

initial_df <- dbGetQuery(con, cohort_query) 
initial_df %>% glimpse()
```

```{r}
summary(initial_df)
```

------------------------------------------------------------------------

## Data cleaning, variable creation

```{r}
# Are there duplicates?
sum(duplicated(initial_df))
```

```{r}
initial_df %>%
  filter(lactate_time < intime | lactate_time > outtime) %>%
  nrow()

```
```{r}

clean_values_df <- initial_df %>%
  mutate(
    lactate_value_num = case_when(
      # For samples containing ">" or "GREATER THAN 30" assign value 31
      
      str_detect(lactate_value, fixed(">")) | 
      str_detect(toupper(lactate_value), "GREATER THAN") ~ 31,
      
      TRUE ~ as.numeric(lactate_value) # try to convert to numeric value, samples with numbers and letters will be converted to NA
    )
  ) %>%
  filter(!is.na(lactate_value_num)) # delete whole row if lactate value is null


# Check for suspicious values
clean_values_df %>%
  filter(lactate_value_num <= 0 | lactate_value_num > 31)

```
```{r}
# icu_dead can't be dead if hospital dead is not
clean_values_df %>%
  filter(icu_dead == 1 & hospital_dead == 0) %>%
  nrow()
```
```{r}
death_counts <- clean_values_df %>%
  group_by(subject_id) %>%
  summarise(
    hosp_dead = n_distinct(hadm_id[hospital_dead == 1], na.rm = TRUE),
    icu_dead  = n_distinct(icustay_id[icu_dead == 1], na.rm = TRUE)
  ) %>%
  filter(icu_dead > 1)
death_counts
# It appears to be one subject with two wrongly assigned deaths
```
```{r}
clean_values_df <- clean_values_df %>%
  mutate(
    # Reassign hospital_dead from first admission
    hospital_dead = if_else(subject_id == 17796 & hadm_id == 119823, 0, hospital_dead),
    
    # Reassign icu_dead from first ICU stay
    icu_dead = if_else(subject_id == 17796 & hadm_id == 119823, 0, icu_dead)
  )
```

```{r}

ggplot(clean_values_df, aes(lactate_value_num)) +
  geom_histogram(bins = 50) +
  scale_x_log10() + # for better visualization and to avoid skewness
  labs(title = "Distribution of lactate values (log scale)")

```
Final dataframe for exploratory analysis:
```{r}
summary(clean_values_df)
```
------------------------------------------------------------------------

## Exploratory analysis

------------------------------------------------------------------------

# Statistical Analysis

## Primary analysis (clustering, logistic regression, lineal model, etc., ROC curves)

------------------------------------------------------------------------

## Subgroup analyses, sensitivity analyses

## Create all figures and tables

------------------------------------------------------------------------

# Machine Learning modeling

------------------------------------------------------------------------

# Next steps

------------------------------------------------------------------------

# Conclusions

------------------------------------------------------------------------

# References

------------------------------------------------------------------------
