---
title: 'Are elevated lactate levels associated with ICU mortality?'
author: "..."
date: "January, 2025"
output:
  pdf_document: 
    toc: true
    toc_depth: 4
    number_sections: true
    fig_width: 7
    fig_height: 5
    fig_caption: true
    keep_tex: false
    latex_engine: xelatex
    highlight: tango
    citation_package: natbib
header-includes:
- \usepackage{xcolor}
- \usepackage{framed}
- \usepackage{listings}
- \usepackage{fancyhdr}
- \usepackage{geometry}
- \usepackage{caption}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{graphicx}
- \geometry{top=2.5cm, bottom=2.5cm, left=2.5cm, right=2.5cm}
- \pagestyle{fancy}
- \fancyfoot[C]{\thepage}
- \renewcommand{\headrulewidth}{0.4pt}
- \renewcommand{\footrulewidth}{0.4pt}
editor_options: 
  markdown: 
    wrap: 72
---

\newpage

Authors' information

\begin{center}
\begin{tabular}{|l|l|}
\hline
\textbf{Nombre} & Marco Russo \\
\hline
\textbf{Email} & mrussorb@uoc.edu \\
\hline
\textbf{GitHub} & https://github.com/marcusRB/ \\
\hline
\textbf{LinkedIn} & https://www.linkedin.com/in/marcusrb/ \\
\hline
\textbf{Fecha} & \today \\
\hline
\end{tabular}
\end{center}
\begin{center}
\begin{tabular}{|l|l|}
\hline
\textbf{Nombre} & ... \\
\hline
\textbf{Email} & ...@...
 \\
\hline
\textbf{GitHub} & https://github.com/ \\
\hline
\textbf{LinkedIn} & https://www.linkedin.com/in/ \\
\hline
\textbf{Fecha} & \today \\
\hline
\end{tabular}
\end{center}
\begin{center}
\begin{tabular}{|l|l|}
\hline
\textbf{Nombre} & ... \\
\hline
\textbf{Email} & ...@...
 \\
\hline
\textbf{GitHub} & https://github.com/ \\
\hline
\textbf{LinkedIn} & https://www.linkedin.com/in/ \\
\hline
\textbf{Fecha} & \today \\
\hline
\end{tabular}
\end{center}
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.width = 10, fig.height = 6)
```

# Project overview

**Research Question**: Are elevated lactate levels associated with ICU
mortality? Study Design: Retrospective cohort study using MIMIC-III
database Primary Analysis: Association between first lactate measurement
post-ICU admission and in-hospital mortality

## Data Description

MIMIC-III is a relational database consisting of 26 tables. Tables are
linked by identifiers which usually have the suffix ‘ID’. For example,
SUBJECT_ID refers to a unique patient, HADM_ID refers to a unique
admission to the hospital, and ICUSTAY_ID refers to a unique admission
to an intensive care unit.

Charted events such as notes, laboratory tests, and fluid balance are
stored in a series of ‘events’ tables. For example the OUTPUTEVENTS
table contains all measurements related to output for a given patient,
while the LABEVENTS table contains laboratory test results for a
patient.

Tables prefixed with ‘D\_’ are dictionary tables and provide definitions
for identifiers. For example, every row of CHARTEVENTS is associated
with a single ITEMID which represents the concept measured, but it does
not contain the actual name of the measurement. By joining CHARTEVENTS
and D_ITEMS on ITEMID, it is possible to identify the concept
represented by a given ITEMID.

Developing the MIMIC data model involved balancing simplicity of
interpretation against closeness to ground truth. As such, the model is
a reflection of underlying data sources, modified over iterations of the
MIMIC database in response to user feedback. Care has been taken to
avoid making assumptions about the underlying data when carrying out
transformations, so MIMIC-III closely represents the raw hospital data.

Broadly speaking, five tables are used to define and track patient
stays: ADMISSIONS; PATIENTS; ICUSTAYS; SERVICES; and TRANSFERS. Another
five tables are dictionaries for cross-referencing codes against their
respective definitions: D_CPT; D_ICD_DIAGNOSES; D_ICD_PROCEDURES;
D_ITEMS; and D_LABITEMS. The remaining tables contain data associated
with patient care, such as physiological measurements, caregiver
observations, and billing information.

In some cases it would be possible to merge tables—for example, the
D_ICD_PROCEDURES and CPTEVENTS tables both contain detail relating to
procedures and could be combined—but our approach is to keep the tables
independent for clarity, since the data sources are significantly
different. Rather than combining the tables within MIMIC data model, we
suggest researchers develop database views and transforms as
appropriate.

## MIMIC-III v1.4

The current version of the database is v1.4. When referencing this
version, we recommend using the full title: MIMIC-III v1.4[^1].

[^1]: Johnson, A., Pollard, T., & Mark, R. (2016). MIMIC-III Clinical
    Database (version 1.4). PhysioNet. RRID:SCR_007345.
    <https://doi.org/10.13026/C2XW26>

MIMIC-III v1.4 was released on 2 September 2016. It was a major release
enhancing data quality and providing a large amount of additional data
for Metavision patients.

------------------------------------------------------------------------

# Data Extraction & Preparation

## Database setup, cohort extraction

```{r database setup}
library(dplyr)
library(tidyr)
library(tibble)
library(lubridate)
library(readr)
library(stringr)
library(ggplot2)
library(data.table)
library(odbc)
library(RMariaDB)
```

```{r}
# Get the credentials file
# It looks like:
################
#username=your.user.name
#password=your.password.assigned
################
creds_file = "creds.txt"
```

```{r}
# Set the username and password
creds <- readLines(creds_file)
cred_list <- setNames(
  sub(".*=", "", creds),
  sub("=.*", "", creds)
)
```

```{r}
con <- dbConnect(
  drv = RMariaDB::MariaDB(),
  username = cred_list[["username"]],
  password = cred_list[["password"]],
  host = "ehr3.deim.urv.cat",
  dbname = "mimiciiiv14",
  port = 3306
)
```

```{r, results='hide'}
#| echo: false
dbListTables(con)
```

We constructed a cohort at the level of individual lactate measurements
obtained during ICU stays. Each row in the dataset corresponds to a
single lactate measurement, and all lactate values recorded during any
ICU stay were included.

Lactate measurements were assigned to ICU stays based on their
timestamp: a measurement was linked to an ICU stay only if it occurred
between the ICU admission (intime) and discharge (outtime) times.

ICU mortality was derived from hospital admission outcomes. For patients
with multiple ICU stays within the same hospital admission, ICU
mortality was assigned exclusively to the final ICU stay if the patient
died during that admission; all preceding ICU stays were labeled as
non-fatal. This approach allows ICU-level mortality attribution in the
absence of a direct ICU death indicator. The final cohort comprised
129,966 lactate measurements, representing multiple ICU stays and
hospital admissions across patients.

```{r}
cohort_query <- "
        WITH icu_ordered AS (
          SELECT
              i.subject_id,
              i.hadm_id,
              i.icustay_id,
              i.intime,
              i.outtime,
              a.hospital_expire_flag AS hospital_dead,
              ROW_NUMBER() OVER (
                  PARTITION BY i.subject_id, i.hadm_id
                  ORDER BY i.outtime DESC
              ) AS rn_icu
          FROM ICUSTAYS i
          JOIN ADMISSIONS a
              ON i.hadm_id = a.hadm_id
      ),
      lactate_ranked AS (
          SELECT
              l.subject_id,
              l.hadm_id,
              io.icustay_id,
              dl.LABEL as measurement_label,
              l.charttime as measurement_time,
              l.value as measurement_value,
              l.valuenum as measurement_value_num,
              l.valueuom as measurement_units,
              l.flag as measurement_flag,
              ROW_NUMBER() OVER (
                  PARTITION BY io.icustay_id
                  ORDER BY l.charttime ASC
              ) AS rn_measurement
          FROM LABEVENTS l
          LEFT JOIN D_LABITEMS dl USING(ITEMID)
          INNER JOIN icu_ordered io USING(subject_id, hadm_id)
          WHERE l.itemid = 50813 -- Id corresponding to lactate
            AND l.value IS NOT NULL
            AND l.charttime BETWEEN io.intime AND io.outtime -- Filter for lab events occurring strictly during the ICU stay
      ),
      confounders AS (
          SELECT
              l.subject_id,
              l.hadm_id,
              io.icustay_id,
              dl.LABEL as measurement_label,
              l.charttime as measurement_time,
              l.value as measurement_value,
              l.valuenum as measurement_value_num,
              l.valueuom as measurement_units,
              l.flag as measurement_flag,
              ROW_NUMBER() OVER (
                  PARTITION BY io.icustay_id, l.itemid
                  ORDER BY l.charttime ASC
              ) AS rn_measurement
          FROM LABEVENTS l
          LEFT JOIN D_LABITEMS dl USING(ITEMID)
          INNER JOIN icu_ordered io USING(subject_id, hadm_id)
          WHERE l.ITEMID IN (50910, 50885) -- 50910 for 'Creatine Kinase (CK)' and 50885 for 'Bilirubin, Total'
          AND l.charttime BETWEEN io.intime AND (io.intime + INTERVAL '24' HOUR) -- Filter for lab events occurring strictly during the first 24h in the ICU stay
      ),
      mabp AS (
        SELECT
          c.subject_id,
              c.hadm_id,
              io.icustay_id,
              di.label as measurement_label,
              c.CHARTTIME as measurement_time,
              c.value as measurement_value,
              c.valuenum as measurement_value_num,
              c.valueuom as measurement_units,
              Null as measurement_flag,
              ROW_NUMBER() OVER (
                  PARTITION BY io.icustay_id, c.itemid
                  ORDER BY c.charttime ASC
              ) AS rn_measurement
          FROM CHARTEVENTS c
          LEFT JOIN D_ITEMS di using(itemid)
          INNER JOIN icu_ordered io USING(subject_id, hadm_id, icustay_id)
          WHERE c.itemid = 220052  -- Arterial Blood Pressure mean
            AND c.valuenum IS NOT NULL
            AND c.charttime BETWEEN io.intime AND (io.intime + INTERVAL '24' HOUR) -- Filter for events occurring strictly during the first 24h in the ICU stay
      ),
      icu_with_lactate AS (
          -- Only ICU stays that have at least one lactate
          SELECT DISTINCT subject_id, hadm_id, icustay_id
          FROM lactate_ranked
          WHERE rn_measurement = 1
      ),
      all_measurements AS (
          SELECT * FROM lactate_ranked WHERE rn_measurement = 1
          UNION ALL
          SELECT * FROM confounders WHERE rn_measurement = 1
          UNION ALL
          SELECT * FROM mabp WHERE rn_measurement = 1
      )
      SELECT
          ROW_NUMBER() OVER (ORDER BY iu.subject_id, iu.hadm_id, iu.icustay_id, am.measurement_label) AS row_id,
          iu.subject_id,
          p.dob,
          YEAR(iu.intime) - YEAR(p.DOB) AS age_icu_entry,
          YEAR(iu.outtime) - YEAR(p.DOB) AS age_icu_exit,
          p.gender,
          iu.hadm_id,
          iu.icustay_id,
          iu.intime,
          iu.outtime,
          iu.hospital_dead,
          CASE
              WHEN iu.hospital_dead = 1 AND iu.rn_icu = 1 THEN 1
              ELSE 0
          END AS icu_dead,
          am.measurement_label,
          am.measurement_time,
          am.measurement_value,
          am.measurement_value_num,
          am.measurement_units,
          am.measurement_flag
      FROM icu_ordered iu
      INNER JOIN icu_with_lactate iwl USING(subject_id,hadm_id,icustay_id)
      INNER JOIN all_measurements am USING(subject_id,hadm_id,icustay_id)
      LEFT JOIN PATIENTS p USING(subject_id)
      ORDER BY iu.subject_id, iu.hadm_id, iu.icustay_id, am.measurement_label;
"

initial_df <- dbGetQuery(con, cohort_query) 
initial_df %>% glimpse()
```

------------------------------------------------------------------------

## Data cleaning, variable creation

```{r}
# Are there duplicates?
sum(duplicated(initial_df))
```

```{r}

clean_values_df <- initial_df %>%
  mutate(
    lactate_value_num = case_when(
      # For samples containing ">" or "GREATER THAN 30" assign value 31
      
      str_detect(lactate_value, fixed(">")) | 
      str_detect(toupper(lactate_value), "GREATER THAN") ~ 31,
      
      TRUE ~ as.numeric(lactate_value) # Convert to numeric value, 
      # samples with numbers and letters will be converted to NA
    )
  ) %>%
  filter(!is.na(lactate_value_num)) # Delete whole row if lactate value is null


# Check for suspicious values
clean_values_df %>%
  filter(lactate_value_num <= 0 | lactate_value_num > 31)

```

Imputed 'normal' for all missing records in the lactate_flag variable.

```{r}
clean_values_df <- clean_values_df %>%
  mutate(
    lactate_flag = if_else(is.na(lactate_flag), "normal", lactate_flag)
  )


ggplot(clean_values_df, aes(x = lactate_value_num, fill = lactate_flag)) +
  geom_histogram(bins = 60, alpha = 0.6, position = "identity", color = "white") +
  
  scale_x_log10() +
  
  scale_fill_manual(values = c("normal" = "#2ecc71", "abnormal" = "#e74c3c")) +
  
  labs(
    title = "Distribution of Lactate Values by Flag",
    x = "Lactate Value (mmol/L) - Log Scale",
    y = "Frequency",
    fill = "Lactate Flag"
  ) +
  
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "bottom"
  )
```


Validate mortality coherence 1: icu_dead cannot be true if hospital_dead is false.
```{r}
clean_values_df %>%
  filter(icu_dead == 1 & hospital_dead == 0) %>%
  nrow()
```
Validate mortality coherence 2: each subject should have at most one recorded death across ICU and hospital stays.
```{r}
death_counts <- clean_values_df %>%
  group_by(subject_id) %>%
  summarise(
    hosp_dead = n_distinct(hadm_id[hospital_dead == 1], na.rm = TRUE),
    icu_dead  = n_distinct(icustay_id[icu_dead == 1], na.rm = TRUE)
  ) %>%
  filter(icu_dead > 1)
death_counts
```
A data inconsistency was identified involving a single subject with two incorrectly assigned mortality flags; these records were manually rectified to ensure data integrity.

```{r}
clean_values_df <- clean_values_df %>%
  mutate(
    # Reassign hospital_dead from first admission
    hospital_dead = if_else(subject_id == 17796 & hadm_id == 119823, 0, hospital_dead),
    
    # Reassign icu_dead from first ICU stay
    icu_dead = if_else(subject_id == 17796 & hadm_id == 119823, 0, icu_dead)
  )
```

```{r}

ggplot(clean_values_df, aes(lactate_value_num)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "white") +
  scale_x_log10() + 
  labs(title = "Distribution of lactate values (log scale)") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

```
The final cohort for exploratory analysis comprises 21,016 unique subjects, accounting for 24,622 hospital admissions and 25,743 ICU stays. The dataset includes a total of 128,715 lactate observations, with an average of 5 measurements per ICU stay, providing a robust longitudinal perspective on patient biomarkers.
```{r}
summary(clean_values_df)
```
------------------------------------------------------------------------

## Exploratory analysis

------------------------------------------------------------------------

# Statistical Analysis

## Primary analysis (clustering, logistic regression, lineal model, etc., ROC curves)

------------------------------------------------------------------------

## Subgroup analyses, sensitivity analyses

## Create all figures and tables

------------------------------------------------------------------------

# Machine Learning modeling

------------------------------------------------------------------------

# Next steps

------------------------------------------------------------------------

# Conclusions

------------------------------------------------------------------------

# References

------------------------------------------------------------------------
